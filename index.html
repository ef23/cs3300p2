<html>
<head>
<title>INFO/CS3300 Project 2</title>
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300, 400,700,800|Space+Mono:400,400i,700" rel="stylesheet">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider@0.2.0/build/d3-simple-slider.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>

<style>
  body { background: #ecf0f1 }
  h1 { font-size: 50px; font-family: 'Open Sans', sans-serif; text-align: center; }
  path.country {  stroke: #888; }
  .yearslider { width:1400px; }
  .heatmap {border: 1px solid #95a5a6; border-radius: 5px; }
</style>
</head>
<body>

<h1> global <span style="color:green;">green</span>house gases </h1>

<div class="page1"></div>
<script>

var windowHeight = window.screen.availHeight
var windowWidth = window.screen.availWidth

var heatmapWidth = .725 * windowWidth
var heatmapHeight = .6 * windowHeight

var donutWidth = .225 * windowWidth
var donutHeight = .6 * windowHeight


var svg = d3.select(".page1").append("svg").attr("height", heatmapHeight).attr("width", heatmapWidth).attr("class", "heatmap");
var donut = d3.select(".page1").append("svg").attr("height", donutHeight).attr("width", donutWidth).attr("class", "heatmap");
d3.select(".page1").append("div").attr("id", "yearslider");


var projection = d3.geoEquirectangular().scale(75);
var pathGenerator = d3.geoPath().projection(projection);

var mapData;
var carbonData;
var countryCodes;
var countries;
var minYear = 1850;
var maxYear= 2014;

d3.queue()
  .defer(d3.json, "data/world-50m.json")
  .defer(d3.json, "data/iso-3166-codes.json")
  .defer(d3.csv, "data/co2emissions.csv")
  .await(page1);

function page1(error, map, codes, carbon) {
  mapData = map;
  countryCodes = codes.map(d => {
    d["country-code"] = Number(d["country-code"]);
    return d;
  });
  carbonData = carbon;
  // console.log(countryCodes)
  countries = topojson.feature(mapData, mapData.objects.countries);
  initMap();
}

function getEmission(countryCode, yearData) {
  var name;
  // console.log(countryCodes)
  for (var i in countryCodes) {
    var country = countryCodes[i];
    if (country["country-code"] === countryCode) {
      name = country["name"]
      break;
    }
  }
  for (var i in yearData) {
    var country = yearData[i];
    if (country["Country"] === name){
      return Number(country["Total"])
    }
  }
  return 0;
}


var colorScale = d3.scaleLinear()
  .interpolate(d3.interpolateHcl)
  .range(["#ffff8c","#d7191c"])

function initMap() {
  var year = 1850;
  var yearData = carbonData.filter(d => d.Year === String(year))
  var validData = yearData.filter(d => Number(d.Total) > 0 && d.Country !== "World" && d.Country !== "European Union (28)")

  colorScale.domain(d3.extent(validData, d => Number(d.Total)))

  projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], countries);
  pathGenerator = d3.geoPath().projection(projection);

  var paths = svg.selectAll("path.country").data(countries.features);
  paths = paths.enter().append("path")
    .attr("class", "country")
    .attr("id", d=>"country" +d.id)
    .attr("opacity", 0.8)
    .attr("fill", d => {
      var carbon = getEmission(d.id, validData);
      return carbon === 0 ? "#ccc" : colorScale(carbon)
    })
    .style("stroke","white")
    .style("stroke-width",0.3)
    .on('mouseover',function(d){
          d3.select(this)
            .style("opacity", 1)
            .style("stroke","white")
            .style("stroke-width",0.6);
        })
    .on('mouseout', function(d){
          d3.select(this)
            .style("opacity", 0.8)
            .style("stroke","white")
            .style("stroke-width",0.3);
        })
    .merge(paths);

  paths.attr("d", function(country){
    return pathGenerator(country);
  })
}


function showMap(year) {
  var yearData = carbonData.filter(d => d.Year === String(year))
  var validData = yearData.filter(d => Number(d.Total) > 0 && d.Country !== "World" && d.Country !== "European Union (28)")

  colorScale.domain(d3.extent(validData, d => Number(d.Total)))

  var paths = svg.selectAll("path.country").data(countries.features);
  var addedpaths = paths.enter().append("path")
  var mergedpaths = addedpaths.merge(paths);

  mergedpaths
    .attr("class", "country")
    .attr("opacity", 0.8)
    .attr("fill", d => {
      var carbon = getEmission(d.id, validData);
      return carbon === 0 ? "#ccc" : colorScale(carbon)
    })
    .on('mouseover',function(d){
          d3.select(this)
            .style("opacity", 1)
            .style("stroke","white")
            .style("stroke-width",0.6);
        })
    .on('mouseout', function(d){
          d3.select(this)
            .style("opacity", 0.8)
            .style("stroke","white")
            .style("stroke-width",0.3);
    })
}

// generate the slider
var yearTicks = []

for (var i = minYear+1; i <= maxYear+1; i+=41){
  yearTicks.push(new Date(i, 0, 0));
}

var yearslider = d3.sliderHorizontal()
  .min(d3.min(yearTicks))
  .max(d3.max(yearTicks))
  .step(1000 * 60 * 60 * 24 * 365)
  .width(1300)
  .tickFormat(d3.timeFormat('%Y'))
  .tickValues(yearTicks)
  .on('onchange', val => {
    showMap(val.getFullYear())
  });
 var g = d3.select("div#yearslider").append("svg")
  .attr("width", 1400)
  .attr("height", 100)
  .append("g")
  .attr("transform", "translate(50,30)");

  g.call(yearslider);
// end slider

</script>
</body>
</html>
