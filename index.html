<html>
<head>
<title>INFO/CS3300 Project 2</title>
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300, 400,700,800|Space+Mono:400,400i,700" rel="stylesheet">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider@0.2.0/build/d3-simple-slider.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>

<style>
/** {border: 1px solid;}*/
  body { background: #ecf0f1 }
  h1 { font-size: 75px; font-family: 'Open Sans', sans-serif; text-align: center; padding: 1% 0%}
  path.country {  stroke: #aaa; }
  .yearslider { width:1400px; }
</style>
</head>
<body>

<h1> global <span style="color:green;">green</span>house gases </h1>
<button id="toggle">Toggle Per Capita</button>
<div class="page1"></div>
</body>
<script>

var windowHeight = window.screen.availHeight
var windowWidth = window.screen.availWidth

var heatmapWidth = .725 * windowWidth
var heatmapHeight = .65 * windowHeight

var donutWidth = .225 * windowWidth
var donutHeight = .65 * windowHeight


var svg = d3.select(".page1").append("svg").attr("height", heatmapHeight).attr("width", heatmapWidth).attr("class", "heatmap");
var donut = d3.select(".page1").append("svg").attr("height", donutHeight).attr("width", donutWidth).attr("class", "donut");
d3.select(".page1").append("div").attr("id", "yearslider");

var projection = d3.geoEquirectangular().scale(75);
var pathGenerator = d3.geoPath().projection(projection);

var mapData;
var carbonData;
var carbonPerCapitaData;
var countryCodes;
var countries;
var minYear = 1850;
var maxYear= 2014;

var perCapita = false;

d3.queue()
  .defer(d3.json, "data/world-50m.json")
  .defer(d3.json, "data/iso-3166-codes.json")
  .defer(d3.csv, "data/co-emissions.csv", parseEmissions)
  .defer(d3.csv, "data/co-emissions-per-capita.csv", parseEmissions)
  .await(page1);

function parseEmissions(row) {
  row["Emissions"] = Number(row["Emissions"]);
  return row;
}

function page1(error, map, codes, carbon, carbonPerCapita) {
  mapData = map;
  countryCodes = codes.map(d => {
    d["country-code"] = Number(d["country-code"])
    return d;
  });
  carbonData = carbon;
  carbonPerCapitaData = carbonPerCapita;
  countries = topojson.feature(mapData, mapData.objects.countries);
  initMap();
}

var colorScale = d3.scaleLinear()
  .interpolate(d3.interpolateHcl)
  .range(["#ffff8c","#d7191c"])

var flagScale = d3.scaleSqrt()
  .range([0,1])

var yearData;
var validData;
var dataArr;
var heatmapTitle = "CARBON DIOXIDE EMISSIONS";

// *********** LEADER TIP ***************** //
// displays the country's name when hovered
d3.select(".donut").append("text")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.05)
  .attr("text-anchor", "middle")
  .attr("text-decoration", "underline")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-weight", "bold")
  .style("font-size", 25)
  .text("Current Emissions Leader:")

var leaderTip = d3.select(".donut").append("text")
  .attr("class", "leader-tip")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.09)
  .attr("text-anchor", "middle")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-weight", "bold")
  .style("font-size", 20)

// displays the emission
var leaderEmissions = d3.select(".donut").append("text")
  .attr("class", "leader-emissions-tip")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.12)
  .attr("text-anchor", "middle")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-weight", "bold")
  .style("font-size", 15)

// displays the appropriate flag
var leaderFlag = d3.select(".donut").append("image")
  .attr("class", "leader-flag-big")
  .attr("x", donutWidth*.33)
  .attr("y", donutHeight*.15)

// *********** END LEADER TIP ************* //

// *********** HOVER TIP ***************** //
// displays the country's name when hovered
var tip = d3.select(".donut").append("text")
  .attr("class", "country-tip")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.47)
  .attr("text-anchor", "middle")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-weight", "bold")
  .style("font-size", 20)
  .text("Hover over a country!")

// displays the emission
var emissions = d3.select(".donut").append("text")
  .attr("class", "country-emissions-tip")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.5)
  .attr("text-anchor", "middle")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-weight", "bold")
  .style("font-size", 15)

// displays the appropriate flag
var flag = d3.select(".donut").append("image")
  .attr("class", "country-flag-big")

d3.select(".donut").append("text")
  .attr("x", donutWidth/2)
  .attr("y", donutHeight*.55)
  .attr("text-anchor", "middle")
  .style("font-family", "Open Sans, sans-serif")
  .style("font-size", 12)
  .text("Flags are scaled on a sqrt scale in comparison to the leader.")


// *********** END HOVER TIP ************* //

// for the heatmap, grabs the emission value
function getEmission(countryCode, yearData) {
  for (var i in dataArr) {
    var country = dataArr[i];
    if (countryCode === country["id"]){
      return (country["Emissions"])
    }
  }
  return 0;
}

// sets the domain of the colorscale to be the year
function setDomain(year) {
  dataArr = [];
  var data = perCapita ? carbonPerCapitaData : carbonData;
  yearData = data.filter(d => d.Year === String(year) && d.Country !== "World" && d.Country !== "European Union (28)")
  validData = yearData.filter(d => (d.Emissions) > 0)

  colorScale.domain(d3.extent(validData, d => (d.Emissions)));
  flagScale.domain(d3.extent(validData, d => (d.Emissions)));

  // generates the data array for this year
  for (var i in validData) {
    var country = validData[i];
    var id;
    var code;
    var region;
    var name = perCapita ? country["Code"] : country["Country"];
    for (var i in countryCodes) {
      var codes = countryCodes[i];
      if (perCapita) {
        if (name === codes["alpha-3"]) {
          code = codes["alpha-2"]
          id = codes["country-code"]
          region = codes["region"]
          break;
        }
      } else {
        if (name === codes["name"]) {
          code = codes["alpha-2"]
          id = codes["country-code"]
          region = codes["region"]
          break;
        }
      }
    }
    dataArr.push({
      Country: country.Country,
      Emissions: country.Emissions,
      id: id,
      code: code,
      region: region
    })
  }
}

// scales the tip text to fit within the box
function scaleTipText(){
  var length = tip.node().getComputedTextLength();
    // rescale text accordingly
  if (length > donutWidth){
    tip.style("font-size",  Math.round(length/30))
  } else {
    tip.style("font-size", 20)
  }
}

// sets the tip for the country to be displayed, with the flag and emissions
function setTip(id) {
  for (var i in dataArr) {
    var country = dataArr[i];
    if (id === country["id"]){
      tip.text(country.Country)
      scaleTipText();
      emissions.text(country.Emissions + " Mt CO2" + (perCapita ? " per capita" : ""))
      flag.attr("href", "data/flags/" + country.code + "-128.png")
        .attr("height", flagScale(country.Emissions) * donutWidth*.25)
        .attr("width", flagScale(country.Emissions) * donutHeight*.25)
      var flagWidth = flag.node().getBBox().width/2;
      var flagHeight = flag.node().getBBox().height/2;
      flag.attr("x", donutWidth/2 - leaderWidth)
          .attr("y", donutHeight*.375 - flagHeight)
      return true;
    }
  }
  return false;
}

var leaderWidth;
// gets the leader of emissions for the current year
function setLeader(year) {
  var leader = dataArr.reduce((acc, l) => acc.Emissions > l.Emissions ? acc : l)
  leaderTip.text(leader.Country)
  leaderEmissions.text(leader.Emissions + " Mt CO2" + (perCapita ? " per capita" : ""))
  leaderFlag.attr("href", "data/flags/" + leader.code + "-128.png")
    .attr("height", donutWidth*.25)
    .attr("width", donutHeight*.25)
  leaderWidth = leaderFlag.node().getBBox().width/2;
  leaderFlag.attr("x", donutWidth/2 - leaderWidth)
}

// initializes the map
function initMap() {
  scaleTipText();
  svg.append("text")
    .attr("id", "title")
    .attr("x", heatmapWidth/2)
    .attr("y", 0.075 * heatmapHeight)
    .style("font-family", "Open Sans, sans-serif")
    .style("font-size", 30)
    .style("font-weight", "bold")
    .style("text-anchor", "middle")
    .text(heatmapTitle + " IN 1969")
  setDomain(1969);
  setLeader(1969);

  // console.log(validData)
  // console.log(d3.extent(validData, d => (d.Emissions)))

  projection.fitExtent([[0,.12*heatmapHeight], [svg.attr("width"), svg.attr("height")]], countries);
  pathGenerator = d3.geoPath().projection(projection);

  var paths = svg.selectAll("path.country").data(countries.features);
  paths = paths.enter().append("path")
    .attr("class", "country")
    .attr("id", d=>"country" +d.id)
    .attr("opacity", 0.8)
    .attr("fill", d => {
      var carbon = getEmission(d.id, validData);
      return carbon === 0 ? "#ccc" : colorScale(carbon)
    })
    .style("stroke","#ccc")
    .style("stroke-width",0.3)
    .on('mouseover',function(d){
        if (setTip(d.id)) {
          d3.select(this)
            .style("opacity", 1)
            .style("stroke","#bbb")
            .style("stroke-width",0.6);
        }
    })
    .on('mouseout', function(d){
          d3.select(this)
            .style("opacity", 0.8)
            .style("stroke","#ccc")
            .style("stroke-width",0.3);
        })
    .merge(paths);

  paths.attr("d", function(country){
    return pathGenerator(country);
  })

  initDonut();
}

// updates the map with the given year
function updateMap(year, isChange) {
  d3.select("#title").transition().text(heatmapTitle + " IN " + year)
  setDomain(year);
  setLeader(year);

  var paths = svg.selectAll("path.country").data(countries.features);
  var addedpaths = paths.enter().append("path")
  var mergedpaths = addedpaths.merge(paths);

  mergedpaths.transition().duration(isChange ? 500 : 0)
    .attr("fill", d => {
      var carbon = getEmission(d.id, validData);
      return carbon === 0 ? "#ccc" : colorScale(carbon)
    })
  drawDonut();
}
// end heatmap
// generate the slider
var yearTicks = []

for (var i = minYear+1; i <= maxYear+1; i+=41){
  yearTicks.push(new Date(i, 0, 0));
}

var prevVal = 1969

var yearslider = d3.sliderHorizontal()
  .min(d3.min(yearTicks))
  .max(d3.max(yearTicks))
  .step(1000 * 60 * 60 * 24 * 365)
  .width(heatmapWidth*.9)
  .tickFormat(d3.timeFormat('%Y'))
  .tickValues(yearTicks)
  .on('onchange', val => {
    val = val.getFullYear()
    if (prevVal !== val){
      var isChange = Math.abs(prevVal - val) > 3
      updateMap(val, isChange)
      prevVal = val;
    }
  });
 var g = d3.select("div#yearslider").append("svg")
  .attr("width", 1400)
  .attr("height", 100)
  .append("g")
  .attr("transform", "translate(50,30)");

  g.call(yearslider);
// end slider
// toggle button
function togglePerCapita() {
  perCapita = !perCapita;
  heatmapTitle = perCapita ? "CARBON DIOXIDE EMISSIONS PER CAPITA" : "CARBON DIOXIDE EMISSIONS";
  updateMap(prevVal, true)
}

d3.select("#toggle")
  .style("left", heatmapWidth/2)
  .style("position", "absolute")
  .on("click", () => togglePerCapita())
// end button
// begin donut graph of continents
var regions = ["Africa", "Americas", "Asia", "Europe", "Oceania"]
var cumulativeData;
var radius = (donutWidth*0.7)/2;
var width = donutWidth/7;
var donutColor = d3.scaleOrdinal(d3.schemeCategory20c)

var arc = d3.arc()
  .innerRadius(radius - width)
  .outerRadius(radius);

var pie = d3.pie()
  .value(function(d) { return d; })
  .sort(null);

var donutTip = d3.select("body")
  .append("div")
  .attr("class", "donut-tip")
  .style("left", heatmapWidth + (donutWidth*.85)/2)
  .style("top", Math.round(donutHeight/1.075))
  .style("width", width)
  .style("text-align", "center")
  .style("position", "absolute")
  .style("z-index", 10)
  .style("font-family", "\"Open Sans\", sans-serif")

donutTip.append("div")
  .attr("class", "region");

donutTip.append("div")
  .attr("class", "emissions");

donutTip.append("div")
  .attr("class", "percent");

function accumulate() {
  cumulativeData = [];
  for (var i in regions) {
    var region = regions[i];
    cumulativeData.push(
      dataArr.filter(d => d.region === region)
            .reduce((acc, d) => acc + d.Emissions, 0)
    )

  }
  donutTip.style("display", "none")
  cumulativeData = cumulativeData.map(d => Number.parseFloat(d).toFixed(3))
}

function donutTipHover(d){
  var total = d3.sum(cumulativeData);
  var percent = Math.round(1000 * d.data / total) / 10;
  donutTip.select(".region").html(regions[d.index]);
  donutTip.select(".emissions").html(d.data + " Mt CO2");
  donutTip.select(".percent").html(percent + "%");
  donutTip.style("display", "block");
}

function initDonut() {
  accumulate()

  var path = donut.selectAll("path").data(pie(cumulativeData))
  var addedpaths = path.enter().append("path")
  addedpaths.merge(path)
    .attr("transform", "translate(" + (donutWidth/2) + "," + (donutHeight/1.3) + ")")
    .attr("d", arc)
    .attr("fill", function(d, i) {
      return donutColor(i);
    })
    .on("mouseover", donutTipHover);
}

// This function is courtesy of https://bl.ocks.org/mbostock/1346410
function arcTween(a) {
  var i = d3.interpolate(this._current, a);
  this._current = i(0);
  return function(t) {
    return arc(i(t));
  };
}

function drawDonut() {
  accumulate()

  var path = donut.selectAll("path").data(pie(cumulativeData))
  var addedpaths = path.enter().append("path")
  addedpaths.merge(path)
    .on("mouseover", donutTipHover)
    .transition().attrTween("d", arcTween)


}
// end donut graph
</script>
</html>
